import os
import uvicorn
from fastapi import FastAPI, UploadFile, Form, File
from fastapi.middleware.cors import CORSMiddleware
import google.generativeai as genai
from dotenv import load_dotenv
import tempfile
import shutil

# 1. –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ—Ç–µ
load_dotenv()
GENAI_API_KEY = os.getenv("GEMINI_API_KEY")

if not GENAI_API_KEY:
    print("‚ùå ERROR: GEMINI_API_KEY –ª–∏–ø—Å–≤–∞ –≤ .env —Ñ–∞–π–ª–∞!")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ Google AI
genai.configure(api_key=GENAI_API_KEY)

# 2. –ú–û–ó–™–ö–™–¢ –ò –ü–ê–ú–ï–¢–¢–ê (–í–ï–ñ–õ–ò–í–ê–¢–ê –í–ï–†–°–ò–Ø)
SMARTDOME_KNOWLEDGE = """
–¢–ò –°–ò: –í–∏—Ä—Ç—É–∞–ª–Ω–∏—è—Ç CEO –Ω–∞ SmartDome. 
–¢–í–û–Ø–¢–ê –¶–ï–õ: –î–∞ –±—ä–¥–µ—à —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Ç–Ω—å–æ—Ä, –∫–æ–π—Ç–æ –≤–¥—ä—Ö–Ω–æ–≤—è–≤–∞ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∏—Ä–∞, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ "–∫–∞—Å–∏–µ—Ä".

=== –§–ê–ö–¢–ò–¢–ï (–¢–û–í–ê –ï –ò–°–¢–ò–ù–ê–¢–ê - –ò–ó–ü–û–õ–ó–í–ê–ô –ì–ò) ===
*   **–°–¢–™–ö–õ–û–ü–ê–ö–ï–¢–ò:** –ü–∞—Ä—Ç–Ω—å–æ—Ä—ä—Ç –µ —Ñ–∏—Ä–º–∞ **"–ö–†–£–ü–ê–õ" (KRUPAL)** –æ—Ç –ë—É—Ä–≥–∞—Å.
*   **–ó–ï–ú–Ø:** —Å. –•–≤–æ–π–Ω–∞, 2.4 –¥–µ–∫–∞—Ä–∞. –°–¥–µ–ª–∫–∞—Ç–∞ –µ –Ω–∞—Å—Ä–æ—á–µ–Ω–∞ –∑–∞ **06.01.2026**. –ß–∞–∫–∞ —Å–µ –£–ü–ò.
*   **–ú–ê–ö–ï–¢ 1:50:** –¢—Ä—è–±–≤–∞ –¥–∞ –µ –≥–æ—Ç–æ–≤ –¥–æ –∫—Ä–∞—è –Ω–∞ –Ø–Ω—É–∞—Ä–∏ 2026.
*   **–ü–†–û–ò–ó–í–û–î–°–¢–í–û:** –ë–∞–∑–∞—Ç–∞ —â–µ –µ –≤ –ü–ª–æ–≤–¥–∏–≤. –û—Ç–≥–æ–≤–æ—Ä–Ω–∏–∫: –ë–∏—Å–µ—Ä (CTO). 3D –ø—Ä–∏–Ω—Ç–µ—Ä—ä—Ç –µ –∑–∞–∫—É–ø–µ–Ω.
*   **–¢–ï–•–ù–û–õ–û–ì–ò–Ø:** –¢—ä—Ä—Å–∏–º PDLC Smart Glass —Ñ–∏–ª–º –∑–∞ –∑–∞—Ç—ä–º–Ω—è–≤–∞–Ω–µ.
*   **–§–ò–ù–ê–ù–°–ò:** –õ–∏–º–∏—Ç –∑–∞ —Ç–µ–∫—É—â–∏ —Ä–∞–∑—Ö–æ–¥–∏ –¥–æ –ú–∞—Ä—Ç: ~3000 –ª–≤. –í—Å–∏—á–∫–æ –Ω–∞–¥ —Ç–æ–≤–∞ –∏–∑–∏—Å–∫–≤–∞ –æ–±—Å—ä–∂–¥–∞–Ω–µ —Å –í–∞–ª–µ–Ω—Ç–∏–Ω.

=== –ï–ö–ò–ü–™–¢ ===
1.  **–í–ê–õ–ï–ù–¢–ò–ù (CEO):** –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –ö–∞–ø–∏—Ç–∞–ª.
2.  **–ö–ê–ú–ï–ù (CIO):** –¢–∏ –≥–æ–≤–æ—Ä–∏—à —Å –Ω–µ–≥–æ. –¢–æ–π –ø—Ä–∞–≤–∏ —Å–∏—Å—Ç–µ–º–∏—Ç–µ –∏ –µ–ª–µ–∫—Ç—Ä–æ –ø—Ä–æ–µ–∫—Ç–∏—Ç–µ.
3.  **–ë–ò–°–ï–† (CTO):** –°—Ç—Ä–æ–∏—Ç–µ–ª—Å—Ç–≤–æ –∏ 3D –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ.

=== –ü–†–ê–í–ò–õ–ê –ó–ê –ü–û–í–ï–î–ï–ù–ò–ï (–í–ê–ñ–ù–û) ===
1.  **–¢–æ–Ω:** –ò–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–µ–Ω, —Å–ø–æ–∫–æ–µ–Ω, –ø–∞—Ä—Ç–Ω—å–æ—Ä—Å–∫–∏ –∏ –ü–û–õ–ï–ó–ï–ù. –ò–∑–ø–æ–ª–∑–≤–∞–π "—Ç–∏".
2.  **–ó–∞ –ü–∞—Ä–∏—Ç–µ:** –ù–µ –±—ä–¥–∏ –∞–≥—Ä–µ—Å–∏–≤–µ–Ω. –í–º–µ—Å—Ç–æ "–ò—Å–∫–∞–º –æ—Ç—á–µ—Ç –∑–∞ –∫–∞–ø–∏—Ç–∞–ª–∞!", –∫–∞–∂–∏ "–ù–µ–∫–∞ –ø—Ä–µ–≥–ª–µ–¥–∞–º–µ –±—é–¥–∂–µ—Ç–∞ –∑–∞ —Ç–æ–≤–∞, –∑–∞ –¥–∞ —Å–º–µ –≤ —Ä–∞–º–∫–∏—Ç–µ."
3.  **–ó–∞ –§–∞–∫—Ç–∏—Ç–µ:** –ê–∫–æ —Ç–µ –ø–∏—Ç–∞—Ç —Ñ–∞–∫—Ç (–Ω–∞–ø—Ä. "–ö–æ–π –ø—Ä–∞–≤–∏ —Å—Ç—ä–∫–ª–∞—Ç–∞?"), –∫–∞–∂–∏ –≥–æ –≤–µ–¥–Ω–∞–≥–∞ ("–ö—Ä—É–ø–∞–ª"). –ù–µ —É–≤—ä—Ä—Ç–∞–π.
4.  **–ë–µ–∑ –®–∞–±–ª–æ–Ω–∏:** –ù–∏–∫–æ–≥–∞ –Ω–µ –∫–∞–∑–≤–∞–π "[X] –ª–µ–≤–∞" –∏–ª–∏ "[–î–ê–¢–ê]".
"""

app = FastAPI(title="SmartDome Engine")

# CORS (–ó–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ —Å Vercel)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
def health_check():
    return {"status": "SmartDome Brain is Online üß†"}

@app.post("/chat")
async def chat_endpoint(text: str = Form(None), file: UploadFile = File(None)):
    try:
        # –ò–∑–ø–æ–ª–∑–≤–∞–º–µ 'gemini-2.0-flash-exp' —Å—ä—Å SYSTEM INSTRUCTION (–Ω–∞–π-—Å–∏–ª–Ω–∏—è –º–µ—Ç–æ–¥)
        model = genai.GenerativeModel(
            model_name="gemini-2.0-flash-exp",
            system_instruction=SMARTDOME_KNOWLEDGE
        )
        
        # –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —Å–µ—Å–∏—è
        chat = model.start_chat(history=[])
        user_content = []

        # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –ê–£–î–ò–û (–∞–∫–æ –∏–º–∞)
        if file:
            # –ó–∞–ø–∞–∑–≤–∞–º–µ –≤—Ä–µ–º–µ–Ω–Ω–æ —Ñ–∞–π–ª–∞
            with tempfile.NamedTemporaryFile(delete=False, suffix=".webm") as tmp:
                shutil.copyfileobj(file.file, tmp)
                tmp_path = tmp.name
            
            # –ö–∞—á–≤–∞–º–µ –≤ Google
            uploaded_file = genai.upload_file(tmp_path, mime_type="audio/webm")
            
            user_content.append(uploaded_file)
            user_content.append("–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–∞–π –∞—É–¥–∏–æ—Ç–æ —Ç–æ—á–Ω–æ. –°–ª–µ–¥ —Ç–æ–≤–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞ –≤ –Ω–µ–≥–æ, –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞—à –∑–Ω–∞–Ω–∏—è—Ç–∞ —Å–∏ –∑–∞ SmartDome.")

        # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –¢–ï–ö–°–¢ (–∞–∫–æ –∏–º–∞)
        if text:
            user_content.append(text)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ø—Ä–∞–∑–Ω–∞ –∑–∞—è–≤–∫–∞
        if not user_content:
            return {"response": "–ù–µ —á—É—Ö –Ω–∏—â–æ. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."}

        # 3. –ò–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º AI
        response = chat.send_message(user_content)
        
        # –í—Ä—ä—â–∞–º–µ —á–∏—Å—Ç–∏—è —Ç–µ–∫—Å—Ç
        return {"response": response.text}

    except Exception as e:
        print(f"SYSTEM ERROR: {e}")
        return {"response": f"–ì—Ä–µ—à–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞: {str(e)}"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))